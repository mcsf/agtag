#!/bin/sh

TARGET="$1"

AG_FMT_OPTS=${AG_FMT_OPTS:=-o --noheading --nobreak}
AG_JS_OPTS=${AG_JS_OPTS:=--js --ts}
AG_PHP_OPTS=${AG_PHP_OPTS:=--php}

JS_SINGLE_EXPORTS='^export (default )?(async )?(function( | *\* *)|class |const |interface )?\K\w+'
JS_OBJECT_EXPORTS='^export {\s*\K(\w+,?\s+)*'
JS_JSDOC_TYPEDEFS='@typedef ({[^}]+} )?\K\w+'
JS_ALL="($JS_SINGLE_EXPORTS)|($JS_OBJECT_EXPORTS)|($JS_JSDOC_TYPEDEFS)"

PHP_ALL='^\s*(public |protected |private |static )*(function |class )\K\w+'

find_all() {
	# shellcheck disable=2086
	ag $AG_FMT_OPTS $AG_JS_OPTS "$JS_ALL" "${TARGET:=.}"
	# shellcheck disable=2086
	ag $AG_FMT_OPTS $AG_PHP_OPTS "$PHP_ALL" "${TARGET:=.}"
}

fix_js_obj_exports() {
	awk -F: '{
		split($3, parts, " ");
		for (p in parts) {
			sub(",", "", parts[p])
			if (parts[p] != "as") print $1 ":" $2 ":" parts[p]
		}
	}'
}

format_tags() {
	awk -F: 'BEGIN{OFS="\t"} {print $3, $1, $2 ";\""}'
}

find_all \
	| fix_js_obj_exports \
	| format_tags \
	| sort
