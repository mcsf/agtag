#!/bin/sh

AG_FMT_OPTS=${AG_FMT_OPTS:=-o --noheading --nobreak}
AG_JS_OPTS=${AG_JS_OPTS:=--js --ts}
AG_PHP_OPTS=${AG_PHP_OPTS:=--php}

# Use `ag` to generate tags (as in `ctags`) for a given project, or to look up
# a specific tag.
#
#    # Generate a tags index
#    $ agtag > tags
#
#    # Crawl the project for a single term
#    $ agtag -t some_symbol_name
#
# `ag` is fed regular expressions aimed at extracting anything that should
# constitute a "public" tags, such as JavaScript functions with the `export`
# keyword, or PHP classes.

generate_tags() {
	find_tag '\w+' "$@" \
		| awk -F: 'BEGIN{OFS="\t"} {print $3, $1, $2 ";\""}' \
		| sort
}

find_tag() {
	tag="$1"; shift
	# shellcheck disable=2086
	ag $AG_FMT_OPTS $AG_JS_OPTS \
		'((^export (default )?(async )?((function( | *\* *)|class |const |interface )?|{ *(?:\w+ as )(\w+, )*))|(@typedef {[^}(]+} ))\K'"$tag"'\b' \
		"$@"
	# shellcheck disable=2086
	ag $AG_FMT_OPTS $AG_PHP_OPTS \
		'^\s*(public |protected |private |static )*(function |class )\K'"$tag"'\b' \
		"$@"
}

# shellcheck disable=2048 disable=2086
if ! args=$(getopt t: $*) ; then
	echo "usage: $(basename $0) [path ...]"
	echo "       $(basename $0) -t term [path ...]"
	exit 2
fi
# shellcheck disable=2086
set -- $args
for i; do
	case "$i" in
		-t)
			term="$2"; shift;
			shift;;
		--)
			shift; break;;
	esac
done

if [ -n "$term" ]
then find_tag "$term" "$@"
else generate_tags "$@"
fi
